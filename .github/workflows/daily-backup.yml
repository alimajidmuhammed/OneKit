# Daily Backup Workflow
# Runs every day at 12:00 AM (midnight) Baghdad time (UTC+3 = 21:00 UTC)
# Creates a backup branch with timestamp

name: Daily Backup

on:
  schedule:
    # Run at 21:00 UTC (which is 00:00 Baghdad time UTC+3)
    - cron: '0 21 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  backup:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for complete backup
      
      - name: Get Current Date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
      
      - name: Create Backup Branch
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # Create backup branch with date
          BACKUP_BRANCH="backup/${{ steps.date.outputs.date }}"
          
          # Check if branch exists, delete if it does (for daily overwrites)
          git push origin --delete $BACKUP_BRANCH 2>/dev/null || true
          
          # Create and push backup branch
          git checkout -b $BACKUP_BRANCH
          git push origin $BACKUP_BRANCH
          
          echo "âœ… Backup created: $BACKUP_BRANCH"
      
      - name: Create Backup Tag
        run: |
          TAG_NAME="backup-${{ steps.date.outputs.date }}"
          
          # Delete existing tag if it exists
          git push origin --delete refs/tags/$TAG_NAME 2>/dev/null || true
          git tag -d $TAG_NAME 2>/dev/null || true
          
          # Create new tag
          git tag -a $TAG_NAME -m "Daily backup - ${{ steps.date.outputs.date }}"
          git push origin $TAG_NAME
          
          echo "âœ… Backup tag created: $TAG_NAME"
      
      - name: Cleanup Old Backups (Keep Last 30 Days)
        run: |
          # Get backup branches older than 30 days
          CUTOFF_DATE=$(date -d '30 days ago' +'%Y-%m-%d')
          
          for branch in $(git branch -r | grep 'origin/backup/' | sed 's/origin\///')
          do
            BRANCH_DATE=$(echo $branch | sed 's/backup\///')
            if [[ "$BRANCH_DATE" < "$CUTOFF_DATE" ]]; then
              echo "Deleting old backup: $branch"
              git push origin --delete $branch 2>/dev/null || true
            fi
          done
          
          echo "âœ… Cleanup completed"
      
      - name: Backup Summary
        run: |
          echo "ðŸ“¦ Backup Summary"
          echo "================"
          echo "Date: ${{ steps.date.outputs.date }}"
          echo "Branch: backup/${{ steps.date.outputs.date }}"
          echo "Tag: backup-${{ steps.date.outputs.date }}"
          echo "Repository: ${{ github.repository }}"
          echo "Commit: ${{ github.sha }}"
